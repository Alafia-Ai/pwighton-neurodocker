# Instructions to install FreeSurfer.

name: freesurfer
binaries:
  arguments:
    required:
    - version
    optional:
      install_path: /opt/freesurfer-{{ self.version }}
      exclude_paths: |
        average/mult-comp-cor
        lib/cuda
        lib/qt
        subjects/V1_average
        subjects/bert
        subjects/cvs_avg35
        subjects/cvs_avg35_inMNI152
        subjects/fsaverage3
        subjects/fsaverage4
        subjects/fsaverage5
        subjects/fsaverage6
        subjects/fsaverage_sym
        trctrain
  urls:
    "7.1.1": https://surfer.nmr.mgh.harvard.edu/pub/dist/freesurfer/7.1.1/freesurfer-linux-centos6_x86_64-7.1.1.tar.gz
    "7.1.1-min": https://dl.dropbox.com/s/c3earkfhhvdyuo4/freesurfer-7.1.1-min.tgz
    "7.1.0": https://surfer.nmr.mgh.harvard.edu/pub/dist/freesurfer/7.1.0/freesurfer-linux-centos6_x86_64-7.1.0.tar.gz
    # 7.0.0 not included because it was recalled several days after release due to a bug. Replaced by 7.1.0.
    # From FreeSurfer team: we recommend that people NOT use 7.0.0 and use 7.1.0 instead.
    "6.0.1": ftp://surfer.nmr.mgh.harvard.edu/pub/dist/freesurfer/6.0.1/freesurfer-Linux-centos6_x86_64-stable-pub-v6.0.1.tar.gz
    "6.0.0": ftp://surfer.nmr.mgh.harvard.edu/pub/dist/freesurfer/6.0.0/freesurfer-Linux-centos6_x86_64-stable-pub-v6.0.0.tar.gz
    # See https://github.com/freesurfer/freesurfer/issues/70
    "6.0.0-min": https://dl.dropbox.com/s/nnzcfttc41qvt31/recon-all-freesurfer6-3.min.tgz
  dependencies:
    apt:
    - bc
    - ca-certificates
    - curl
    - libgomp1
    - libxmu6
    - libxt6
    - tcsh
    - perl
    yum:
    - bc
    - curl
    - libgomp
    - libXmu
    - libXt
    - tcsh
    - perl
  env:
    # From https://github.com/freesurfer/freesurfer/blob/54018f7d6f620d6288b28f50e14a0a4ba421757c/Dockerfile#L20-L42
    # freesurfer env
    OS: "Linux"
    PATH: "{{ self.install_path }}/bin:{{ self.install_path }}/fsfast/bin:{{ self.install_path }}/tktools:{{ self.install_path }}/mni/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    FREESURFER_HOME: "{{ self.install_path }}"
    FREESURFER: "{{ self.install_path }}"
    SUBJECTS_DIR: "{{ self.install_path }}/subjects"
    LOCAL_DIR: "{{ self.install_path }}/local"
    FSFAST_HOME: "{{ self.install_path }}/fsfast"
    FMRI_ANALYSIS_DIR: "{{ self.install_path }}/fsfast"
    FUNCTIONALS_DIR: "{{ self.install_path }}/sessions"
    # default freesurfer options
    FS_OVERRIDE: "0"
    FIX_VERTEX_AREA: ""
    FSF_OUTPUT_FORMAT: "nii.gz"
    # mni environment requirements
    MINC_BIN_DIR: "{{ self.install_path }}/mni/bin"
    MINC_LIB_DIR: "{{ self.install_path }}/mni/lib"
    MNI_DIR: "{{ self.install_path }}/mni"
    MNI_DATAPATH: "{{ self.install_path }}/mni/data"
    MNI_PERL5LIB: "{{ self.install_path }}/mni/share/perl5"
    PERL5LIB: "{{ self.install_path }}/mni/share/perl5"
  instructions: |
    {{ self.install_dependencies() }}
    echo "Downloading FreeSurfer ..."
    mkdir -p {{ self.install_path }}
    curl -fL {{ self.urls[self.version] }} \
    | tar -xz -C {{ self.install_path }} --strip-components 1 {% if self.exclude_paths -%}\
    {%- for exclude_path in self.exclude_paths.split() %}
      {% if not loop.last -%}
      --exclude='{{ exclude_path }}' \
      {%- else -%}
      --exclude='{{ exclude_path }}'
      {%- endif -%}
    {%- endfor %}
    {%- endif %}

source:
  arguments:
    required:
    - version
    optional:
      license_base64: ""
      repo: https://github.com/freesurfer/freesurfer
      pkg_url: http://surfer.nmr.mgh.harvard.edu/pub/data/fspackages/prebuilt/centos7-packages.tar.gz
      annex: https://surfer.nmr.mgh.harvard.edu/pub/dist/freesurfer/repo/annex.git
      minimal: "ON"
      build_guis: "OFF"
      infant_module: "OFF"
      install_python_deps: "OFF"
      distribute_fspython: "OFF"
      martinos_build: "OFF"
      fortran_libs: /usr/lib/gcc/x86_64-linux-gnu/5/libgfortran.so
      source_path: /tmp/freesurfer/freesurfer-{{ self.version }}
      pkg_path: /tmp/freesurfer/pkg
      install_path: /opt/freesurfer-{{ self.version }}
      # This one has to be quoted with \"s for some reason
      license_path: "{{ self.install_path }}/license.txt"
      cmake_opts: -DCMAKE_INSTALL_PREFIX={{ self.install_path }} -DBUILD_GUIS={{ self.build_guis }} -DMINIMAL={{ self.minimal }} -DINFANT_MODULE={{ self.infant_module }} -DFS_PACKAGES_DIR={{ self.pkg_path }} -DGFORTRAN_LIBRARIES={{ self.fortran_libs }} -DINSTALL_PYTHON_DEPENDENCIES={{ self.install_python_deps }} -DDISTRIBUTE_FSPYTHON={{ self.distribute_fspython }} -DMARTINOS_BUILD={{ self.martinos_build }}
      make_opts: -j4
  env:
    FS_LICENSE: "{{ self.license_path }}"
    # From https://github.com/freesurfer/freesurfer/blob/54018f7d6f620d6288b28f50e14a0a4ba421757c/Dockerfile#L20-L42
    # freesurfer env
    OS: "Linux"
    PATH: "{{ self.install_path }}/bin:{{ self.install_path }}/fsfast/bin:{{ self.install_path }}/tktools:{{ self.install_path }}/mni/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    FREESURFER_HOME: "{{ self.install_path }}"
    FREESURFER: "{{ self.install_path }}"
    SUBJECTS_DIR: "{{ self.install_path }}/subjects"
    LOCAL_DIR: "{{ self.install_path }}/local"
    FSFAST_HOME: "{{ self.install_path }}/fsfast"
    FMRI_ANALYSIS_DIR: "{{ self.install_path }}/fsfast"
    FUNCTIONALS_DIR: "{{ self.install_path }}/sessions"
    # default freesurfer options
    FS_OVERRIDE: "0"
    FIX_VERTEX_AREA: ""
    FSF_OUTPUT_FORMAT: "nii.gz"
    # mni environment requirements
    MINC_BIN_DIR: "{{ self.install_path }}/mni/bin"
    MINC_LIB_DIR: "{{ self.install_path }}/mni/lib"
    MNI_DIR: "{{ self.install_path }}/mni"
    MNI_DATAPATH: "{{ self.install_path }}/mni/data"
    MNI_PERL5LIB: "{{ self.install_path }}/mni/share/perl5"
    PERL5LIB: "{{ self.install_path }}/mni/share/perl5"
  dependencies:
    apt:
    - ca-certificates
    - cmake
    - git
    - git-annex
    - make
    - bc
    - binutils
    - bzip2
    - curl
    - g++-4.8
    - gcc-4.8-base
    - gcc-4.8
    - gfortran-4.8
    - libbz2-dev
    - libfreetype6-dev
    - libgfortran-4.8-dev
    - libglu1-mesa-dev
    - libgomp1
    - libjpeg62-dev
    - libopenblas-dev
    - libssl-dev
    - libtool
    - libtool-bin
    - libx11-dev
    - libxaw7-dev
    - libxi-dev
    - libxml2-utils
    - libxmu-dev
    - libxmu-headers
    - libxmu6
    - libxt-dev
    - libxt6
    - perl
    - sudo
    - tar
    - tcsh
    - unzip
    - uuid-dev
    - vim-common
    - wget
    yum:
    - ca-certificates
    - cmake
    - gcc-c++
    - git
    - make
  instructions: |
    {{ self.install_dependencies() }}
    # git config
    git config --global user.email "CI@example.com"
    git config --global user.name "CI"
    # Compile with gcc 4.8
    # --------------------
    update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.8 100
    update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.8 100
    update-alternatives --install /usr/bin/gfortran gfortran /usr/bin/gfortran-4.8 100
    # FreeSurfer needs python > 3.6 (? todo: verify)
    # From: https://github.com/pwighton/fs-docker/blob/09cc6b0b6c0538cbb182b04435daf85c123a63d5/build/Dockerfile#L66
    # Alternative is https://github.com/ReproNim/neurodocker/blob/master/neurodocker/templates/afni.yaml
    # But it installs python 3.5
    # -------------------------------------------------------------------------
    curl -sSL --retry 5 https://www.python.org/ftp/python/3.6.5/Python-3.6.5.tgz | tar -xz -C /tmp
    cd /tmp/Python-3.6.5
    ./configure
    make
    make install 
    cd /
    rm -rf /tmp/Python-3.6.5
    pip3 install -q --no-cache-dir -U pip
    pip3 install -q --no-cache-dir wheel
    sync
    # FreeSurfer needs CMake 3.9 or higher
    # Taken from: https://github.com/Rikorose/gcc-cmake/blob/master/gcc-4/Dockerfile
    # ------------------------------------------------------------------------------
    wget https://github.com/Kitware/CMake/releases/download/v3.19.0/cmake-3.19.0-Linux-x86_64.sh -q -O /tmp/cmake-install.sh
    chmod u+x /tmp/cmake-install.sh
    mkdir -p /usr/share/cmake-3.19.0
    /tmp/cmake-install.sh --skip-license --prefix=/usr/share/cmake-3.19.0
    CMAKE_BINPATH=`which cmake`
    rm -rf $CMAKE_BINPATH
    ln -s /usr/share/cmake-3.19.0/bin/cmake $CMAKE_BINPATH
    rm /tmp/cmake-install.sh
    # Compile FreeSurfer
    # https://github.com/pwighton/fs-docker (todo: maybe a newer way?)
    # ----------------------------------------------------------------
    mkdir -p {{ self.pkg_path }}
    mkdir -p {{ self.install_path }}
    wget -q -c {{ self.pkg_url }} -O - | tar -xz -C {{ self.pkg_path }} 
    mv {{ self.pkg_path }}/packages/* {{ self.pkg_path }}
    rm -rf {{ self.pkg_path }}/packages
    git clone --single-branch --branch {{ self.version }} {{ self.repo }} {{ self.source_path }}
    # Compile
    # -------------------------------------------------
    cd {{ self.install_path }}
    cmake {{ self.cmake_opts }} {{ self.source_path }}
    make {{ self.make_opts }}
    # Files needed to be downloaded from the annex before we can run `make install`
    # todo: tag files in annex so we can run `git annex get --metadata fstags=makeinstall` (faster)
    # -------------------------------------------------
    cd {{ self.source_path }}
    git remote add datasrc {{ self.annex }}
    git fetch datasrc
    # PW 2021/03/04: Werid.. this returns an error code, but things still work?
    #                So hardwire the exit code to zero so `docker build` doesn't error out
    #                This is because surfer.nmr now runs git-annex 8(?) todo: upgrade
    git annex enableremote datasrc || true
    git annex get -q .
    # Install
    # -------------------------------------------------    
    cd {{ self.install_path }}
    make install
    pip3 install -r {{ self.source_path }}/python/requirements.txt
    # If self.license_base64 populated, decode from base64 and write to self.license_path
    # https://github.com/pwighton/fs-docker/blob/master/run/entrypoint.freesurfer-run.bash
    # -------------------------------------------------
    if [ -n "{{ self.license_base64 }}" ]; then \
      echo {{ self.license_base64 }} | base64 -d > {{ self.license_path }}; \
    fi
